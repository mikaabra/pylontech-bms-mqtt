# Rack Solar Bridge - Phase 2b: SmartShunt + EPEVER
# ESP32-S3 Waveshare board for SmartShunt (VE.Direct) + EPEVER MPPT (RS485)
# Phase 2b: VE.Direct SmartShunt and RS485 EPEVER both enabled

substitutions:
  device_name: rack-solar-bridge
  friendly_name: "Rack Solar Bridge"
  mqtt_prefix: rack-solar
  # Placeholders for sensors (will be enabled in Phase 2)
  version: "2026.1.5"
  hardware_model: "ESP32-S3 Waveshare"
  manufacturer: "ESPHome"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  min_version: 2026.1.0
  on_boot:
    priority: -100
    then:
      - logger.log: 
          format: "Rack Solar Bridge booting - Phase 2b (SmartShunt + EPEVER)"
          level: INFO
      - lambda: |-
          id(discovery_sent) = false;

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:
  level: DEBUG
  baud_rate: 115200

# WiFi configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Enable fallback hotspot (captive portal)
  ap:
    ssid: "${device_name}-fallback"
    password: "fallback123"

captive_portal:

# Web server for debugging
web_server:
  port: 80

# MQTT configuration
mqtt:
  id: mqtt_client
  broker: !secret mqtt_host
  port: 1883
  username: !secret mqtt_user
  password: !secret mqtt_password
  
  # Device availability
  birth_message:
    topic: ${mqtt_prefix}/status
    payload: "online"
    retain: true
  will_message:
    topic: ${mqtt_prefix}/status
    payload: "offline"
    retain: true
  
  # Disable native discovery - we'll use custom HA Discovery in Phase 2
  discovery: false
  
  on_connect:
    - logger.log:
        format: "MQTT connected to broker"
        level: INFO
    - lambda: |-
        if (!id(discovery_sent)) {
          id(publish_discovery).execute();
          id(discovery_sent) = true;
        } else {
          ESP_LOGI("mqtt", "Discovery already sent this boot, skipping");
        }
    - mqtt.publish:
        topic: ${mqtt_prefix}/info
        payload: "Rack Solar Bridge Phase 3 (HA Discovery)"
        retain: false

# OTA configuration
ota:
  - platform: esphome
    password: !secret ota_password

# =============================================================================
# PHASE 3: HA Discovery publishing script
# =============================================================================

script:
  - id: publish_discovery
    mode: single
    then:
      - lambda: |-
          ESP_LOGI("mqtt", "Publishing HA Discovery configs for Rack Solar Bridge...");
          
          // Device info shared by all entities
          char device_payload[256];
          snprintf(device_payload, sizeof(device_payload),
            R"("device":{"identifiers":["rack_solar_bridge"],"name":"Rack Solar Bridge","model":"Waveshare ESP32-S3","manufacturer":"ESPHome"})");
          
          char avail_payload[128];
          snprintf(avail_payload, sizeof(avail_payload),
            R"("availability_topic":"${mqtt_prefix}/status","payload_available":"online","payload_not_available":"offline")");
          
          char topic[160];
          char payload[768];
          int publish_count = 0;
          
          // Helper lambda: pace publishes
          auto pace_publish = [&publish_count]() {
            publish_count++;
            if (publish_count % 15 == 0) {
              delay(10);
            }
          };
          
          // SmartShunt sensors
          const char* smartshunt_sensors[][5] = {
            {"ss_battery_voltage", "SmartShunt Battery Voltage", "${mqtt_prefix}/smartshunt/battery_voltage", "V", "voltage"},
            {"ss_battery_current", "SmartShunt Battery Current", "${mqtt_prefix}/smartshunt/battery_current", "A", "current"},
            {"ss_state_of_charge", "SmartShunt State of Charge", "${mqtt_prefix}/smartshunt/state_of_charge", "%", "battery"},
            {"ss_instantaneous_power", "SmartShunt Power", "${mqtt_prefix}/smartshunt/power", "W", "power"},
            {"ss_battery_temperature", "SmartShunt Battery Temperature", "${mqtt_prefix}/smartshunt/temperature", "°C", "temperature"},
            {"ss_consumed_amp_hours", "SmartShunt Consumed Ah", "${mqtt_prefix}/smartshunt/consumed_ah", "Ah", ""},
            {"ss_time_to_go", "SmartShunt Time To Go", "${mqtt_prefix}/smartshunt/time_to_go", "min", ""},
            {"ss_depth_deepest_discharge", "SmartShunt Deepest Discharge", "${mqtt_prefix}/smartshunt/deepest_discharge", "Ah", ""},
            {"ss_depth_last_discharge", "SmartShunt Last Discharge", "${mqtt_prefix}/smartshunt/last_discharge", "Ah", ""},
            {"ss_depth_average_discharge", "SmartShunt Avg Discharge", "${mqtt_prefix}/smartshunt/avg_discharge", "Ah", ""},
            {"ss_number_charge_cycles", "SmartShunt Charge Cycles", "${mqtt_prefix}/smartshunt/charge_cycles", "", ""},
            {"ss_number_full_discharges", "SmartShunt Full Discharges", "${mqtt_prefix}/smartshunt/full_discharges", "", ""},
            {"ss_cumulative_amp_hours", "SmartShunt Cumulative Ah", "${mqtt_prefix}/smartshunt/cumulative_ah", "Ah", ""},
            {"ss_min_battery_voltage", "SmartShunt Min Voltage", "${mqtt_prefix}/smartshunt/min_voltage", "V", "voltage"},
            {"ss_max_battery_voltage", "SmartShunt Max Voltage", "${mqtt_prefix}/smartshunt/max_voltage", "V", "voltage"},
            {"ss_last_full_charge", "SmartShunt Last Full Charge", "${mqtt_prefix}/smartshunt/last_full_charge", "min", ""},
            {"ss_amount_discharged_energy", "SmartShunt Discharged Energy", "${mqtt_prefix}/smartshunt/discharged_energy", "Wh", "energy"},
            {"ss_amount_charged_energy", "SmartShunt Charged Energy", "${mqtt_prefix}/smartshunt/charged_energy", "Wh", "energy"},
          };
          
          for (int i = 0; i < 18; i++) {
            snprintf(topic, sizeof(topic), "homeassistant/sensor/rack_solar/%s/config", smartshunt_sensors[i][0]);
            bool ok = false;
            if (strlen(smartshunt_sensors[i][3]) > 0 && strlen(smartshunt_sensors[i][4]) > 0) {
              ok = snprintf(payload, sizeof(payload),
                R"({"name":"%s","state_topic":"%s","unique_id":"rack_solar_%s","unit_of_measurement":"%s","device_class":"%s","state_class":"measurement",%s,%s})",
                smartshunt_sensors[i][1], smartshunt_sensors[i][2], smartshunt_sensors[i][0], 
                smartshunt_sensors[i][3], smartshunt_sensors[i][4], avail_payload, device_payload) > 0;
            } else if (strlen(smartshunt_sensors[i][3]) > 0) {
              ok = snprintf(payload, sizeof(payload),
                R"({"name":"%s","state_topic":"%s","unique_id":"rack_solar_%s","unit_of_measurement":"%s","state_class":"measurement",%s,%s})",
                smartshunt_sensors[i][1], smartshunt_sensors[i][2], smartshunt_sensors[i][0], 
                smartshunt_sensors[i][3], avail_payload, device_payload) > 0;
            } else {
              ok = snprintf(payload, sizeof(payload),
                R"({"name":"%s","state_topic":"%s","unique_id":"rack_solar_%s",%s,%s})",
                smartshunt_sensors[i][1], smartshunt_sensors[i][2], smartshunt_sensors[i][0], 
                avail_payload, device_payload) > 0;
            }
            if (ok) {
              id(mqtt_client).publish(std::string(topic), std::string(payload), 0, true);
              pace_publish();
            }
          }
          
          // EPEVER sensors
          const char* epever_sensors[][5] = {
            {"epever_solar_voltage", "EPEVER Solar Voltage", "${mqtt_prefix}/epever/solar_voltage", "V", "voltage"},
            {"epever_pv_current", "EPEVER PV Current", "${mqtt_prefix}/epever/pv_current", "A", "current"},
            {"epever_solar_power", "EPEVER Solar Power", "${mqtt_prefix}/epever/solar_power", "W", "power"},
            {"epever_battery_capacity", "EPEVER Battery Capacity", "${mqtt_prefix}/epever/battery_capacity", "%", "battery"},
            {"epever_device_temp", "EPEVER Device Temperature", "${mqtt_prefix}/epever/device_temp", "°C", "temperature"},
            {"epever_battery_voltage", "EPEVER Battery Voltage", "${mqtt_prefix}/epever/battery_voltage", "V", "voltage"},
            {"epever_battery_current", "EPEVER Battery Current", "${mqtt_prefix}/epever/battery_current", "A", "current"},
            {"epever_total_energy", "EPEVER Total Energy", "${mqtt_prefix}/epever/total_energy", "kWh", "energy"},
          };
          
          for (int i = 0; i < 8; i++) {
            snprintf(topic, sizeof(topic), "homeassistant/sensor/rack_solar/%s/config", epever_sensors[i][0]);
            bool ok = snprintf(payload, sizeof(payload),
              R"({"name":"%s","state_topic":"%s","unique_id":"rack_solar_%s","unit_of_measurement":"%s","device_class":"%s","state_class":"measurement",%s,%s})",
              epever_sensors[i][1], epever_sensors[i][2], epever_sensors[i][0], 
              epever_sensors[i][3], epever_sensors[i][4], avail_payload, device_payload) > 0;
            if (ok) {
              id(mqtt_client).publish(std::string(topic), std::string(payload), 0, true);
              pace_publish();
            }
          }
          
          ESP_LOGI("mqtt", "Published %d discovery configs", publish_count);

# =============================================================================
# HARDWARE INTERFACES
# =============================================================================

# UART interfaces (VE.Direct + RS485)
uart:
  - id: vedirect_uart
    rx_pin: GPIO4  # VE.Direct receive via voltage divider
    baud_rate: 19200
    rx_buffer_size: 1024
  
  - id: rs485_uart
    tx_pin: GPIO17
    rx_pin: GPIO18
    baud_rate: 115200
    data_bits: 8
    stop_bits: 1
    parity: NONE
    flow_control_pin: GPIO21
    rx_buffer_size: 1024

# External component for Victron (SmartShunt)
external_components:
  - source: github://KinDR007/VictronMPPT-ESPHOME@main
    refresh: 0s

# Victron component
victron:
  uart_id: vedirect_uart
  id: smartshunt
  throttle: 10s

# Modbus controller for EPEVER
modbus:
  id: modbus1
  uart_id: rs485_uart

modbus_controller:
  - id: epever
    address: 0x1
    modbus_id: modbus1
    command_throttle: 0ms
    update_interval: 30s

# =============================================================================
# SENSORS - Placeholder for Phase 2
# =============================================================================

sensor:
  # Uptime sensor for basic monitoring
  - platform: uptime
    name: "Uptime"
    id: uptime_sensor
    update_interval: 60s

  # WiFi signal strength
  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_signal_db
    update_interval: 60s
    unit_of_measurement: "dBm"
    device_class: signal_strength

  # Free heap for diagnostics
  - platform: template
    name: "Free Heap"
    id: free_heap_sensor
    unit_of_measurement: "bytes"
    lambda: return heap_caps_get_free_size(MALLOC_CAP_8BIT);
    update_interval: 30s
    entity_category: diagnostic

  # SmartShunt sensors
  - platform: victron
    victron_id: smartshunt
    battery_voltage:
      name: "SmartShunt Battery Voltage"
      id: ss_battery_voltage
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_battery_voltage);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_battery_voltage) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/battery_voltage", to_string(new_val));
              }
    battery_current:
      name: "SmartShunt Battery Current"
      id: ss_battery_current
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_battery_current);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_battery_current) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/battery_current", to_string(new_val));
              }
    state_of_charge:
      name: "SmartShunt State of Charge"
      id: ss_state_of_charge
      force_update: false
      on_value:
        then:
          - lambda: |-
              int new_val = (int) roundf(x);
              int last_val = id(last_ss_state_of_charge);
              int threshold = 1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1) {
                publish = true;
              } else if (abs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_state_of_charge) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/state_of_charge", to_string(new_val));
              }
    instantaneous_power:
      name: "SmartShunt Power"
      id: ss_instantaneous_power
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_instantaneous_power);
              float threshold = 1.0;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_instantaneous_power) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/instantaneous_power", to_string(new_val));
              }
    battery_temperature:
      name: "SmartShunt Battery Temperature"
      id: ss_battery_temperature
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_battery_temperature);
              float threshold = 0.5;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -999.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_battery_temperature) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/battery_temperature", to_string(new_val));
              }
    consumed_amp_hours:
      name: "SmartShunt Consumed Amp Hours"
      id: ss_consumed_amp_hours
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_consumed_amp_hours);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -999.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_consumed_amp_hours) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/consumed_amp_hours", to_string(new_val));
              }
    time_to_go:
      name: "SmartShunt Time To Go"
      id: ss_time_to_go
      force_update: false
      on_value:
        then:
          - lambda: |-
              int new_val = (int) roundf(x);
              int last_val = id(last_ss_time_to_go);
              int threshold = 1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1) {
                publish = true;
              } else if (abs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_time_to_go) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/time_to_go", to_string(new_val));
              }
    depth_of_the_deepest_discharge:
      name: "SmartShunt Deepest Discharge"
      id: ss_depth_deepest_discharge
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_depth_deepest_discharge);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_depth_deepest_discharge) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/depth_deepest_discharge", to_string(new_val));
              }
    depth_of_the_last_discharge:
      name: "SmartShunt Last Discharge"
      id: ss_depth_last_discharge
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_depth_last_discharge);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_depth_last_discharge) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/depth_last_discharge", to_string(new_val));
              }
    depth_of_the_average_discharge:
      name: "SmartShunt Average Discharge"
      id: ss_depth_average_discharge
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_depth_average_discharge);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_depth_average_discharge) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/depth_average_discharge", to_string(new_val));
              }
    number_of_charge_cycles:
      name: "SmartShunt Charge Cycles"
      id: ss_number_charge_cycles
      force_update: false
      on_value:
        then:
          - lambda: |-
              int new_val = (int) roundf(x);
              int last_val = id(last_ss_number_charge_cycles);
              int threshold = 1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1) {
                publish = true;
              } else if (abs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_number_charge_cycles) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/number_charge_cycles", to_string(new_val));
              }
    number_of_full_discharges:
      name: "SmartShunt Full Discharges"
      id: ss_number_full_discharges
      force_update: false
      on_value:
        then:
          - lambda: |-
              int new_val = (int) roundf(x);
              int last_val = id(last_ss_number_full_discharges);
              int threshold = 1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1) {
                publish = true;
              } else if (abs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_number_full_discharges) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/number_full_discharges", to_string(new_val));
              }
    cumulative_amp_hours_drawn:
      name: "SmartShunt Cumulative Ah Drawn"
      id: ss_cumulative_amp_hours
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_consumed_amp_hours);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -999.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_consumed_amp_hours) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/cumulative_amp_hours", to_string(new_val));
              }
    min_battery_voltage:
      name: "SmartShunt Min Battery Voltage"
      id: ss_min_battery_voltage
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_min_battery_voltage);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_min_battery_voltage) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/min_battery_voltage", to_string(new_val));
              }
    max_battery_voltage:
      name: "SmartShunt Max Battery Voltage"
      id: ss_max_battery_voltage
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_max_battery_voltage);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_max_battery_voltage) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/max_battery_voltage", to_string(new_val));
              }
    last_full_charge:
      name: "SmartShunt Last Full Charge"
      id: ss_last_full_charge
      force_update: false
      on_value:
        then:
          - lambda: |-
              int new_val = (int) roundf(x);
              int last_val = id(last_ss_last_full_charge);
              int threshold = 1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1) {
                publish = true;
              } else if (abs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_last_full_charge) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/last_full_charge", to_string(new_val));
              }
    amount_of_discharged_energy:
      name: "SmartShunt Discharged Energy"
      id: ss_amount_discharged_energy
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_amount_discharged_energy);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_amount_discharged_energy) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/amount_discharged_energy", to_string(new_val));
              }
    amount_of_charged_energy:
      name: "SmartShunt Charged Energy"
      id: ss_amount_charged_energy
      force_update: false
      on_value:
        then:
          - lambda: |-
              float new_val = x;
              float last_val = id(last_ss_amount_charged_energy);
              float threshold = 0.1;
              uint32_t now = millis();
              uint32_t last_publish = id(last_ss_data_publish);
              bool publish = false;
              if (last_val == -1.0) {
                publish = true;
              } else if (fabs(new_val - last_val) >= threshold) {
                publish = true;
              } else if ((now - last_publish) >= 60000) {
                publish = true;
              }
              if (publish) {
                id(last_ss_amount_charged_energy) = new_val;
                id(last_ss_data_publish) = now;
                id(mqtt_client).publish(topic + "/amount_charged_energy", to_string(new_val));
              }

  # EPEVER MPPT sensors
  - platform: modbus_controller
    modbus_controller_id: epever
    name: "EPEVER Solar Voltage"
    id: epever_solar_voltage
    register_type: read
    address: 12544
    value_type: U_WORD
    filters:
      - multiply: 0.01
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    force_update: false
    on_value:
      then:
        - lambda: |-
            float new_val = x;
            float last_val = id(last_epever_solar_voltage);
            float threshold = 0.1;
            uint32_t now = millis();
            uint32_t last_publish = id(last_epever_data_publish);
            bool publish = false;
            if (last_val == -1.0) {
              publish = true;
            } else if (fabs(new_val - last_val) >= threshold) {
              publish = true;
            } else if ((now - last_publish) >= 60000) {
              publish = true;
            }
            if (publish) {
              id(last_epever_solar_voltage) = new_val;
              id(last_epever_data_publish) = now;
              id(mqtt_client).publish(topic + "/solar_voltage_epever", to_string(new_val));
            }

  - platform: modbus_controller
    modbus_controller_id: epever
    name: "EPEVER PV Array Current"
    id: epever_pv_current
    register_type: read
    address: 12545
    value_type: U_WORD
    filters:
      - multiply: 0.01
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    force_update: false
    on_value:
      then:
        - lambda: |-
            float new_val = x;
            float last_val = id(last_epever_pv_current);
            float threshold = 0.1;
            uint32_t now = millis();
            uint32_t last_publish = id(last_epever_data_publish);
            bool publish = false;
            if (last_val == -1.0) {
              publish = true;
            } else if (fabs(new_val - last_val) >= threshold) {
              publish = true;
            } else if ((now - last_publish) >= 60000) {
              publish = true;
            }
            if (publish) {
              id(last_epever_pv_current) = new_val;
              id(last_epever_data_publish) = now;
              id(mqtt_client).publish(topic + "/pv_current_epever", to_string(new_val));
            }

  - platform: modbus_controller
    modbus_controller_id: epever
    name: "EPEVER Solar Power"
    id: epever_solar_power
    register_type: read
    address: 12546
    value_type: U_DWORD_R
    filters:
      - multiply: 0.01
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    force_update: false
    on_value:
      then:
        - lambda: |-
            float new_val = x;
            float last_val = id(last_epever_solar_power);
            float threshold = 1.0;
            uint32_t now = millis();
            uint32_t last_publish = id(last_epever_data_publish);
            bool publish = false;
            if (last_val == -1.0) {
              publish = true;
            } else if (fabs(new_val - last_val) >= threshold) {
              publish = true;
            } else if ((now - last_publish) >= 60000) {
              publish = true;
            }
            if (publish) {
              id(last_epever_solar_power) = new_val;
              id(last_epever_data_publish) = now;
              id(mqtt_client).publish(topic + "/solar_power_epever", to_string(new_val));
            }

  - platform: modbus_controller
    modbus_controller_id: epever
    name: "EPEVER Battery Capacity"
    id: epever_battery_capacity
    register_type: read
    address: 12570
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    force_update: false
    on_value:
      then:
        - lambda: |-
            int new_val = (int) roundf(x);
            int last_val = id(last_epever_battery_capacity);
            int threshold = 1;
            uint32_t now = millis();
            uint32_t last_publish = id(last_epever_data_publish);
            bool publish = false;
            if (last_val == -1) {
              publish = true;
            } else if (abs(new_val - last_val) >= threshold) {
              publish = true;
            } else if ((now - last_publish) >= 60000) {
              publish = true;
            }
            if (publish) {
              id(last_epever_battery_capacity) = new_val;
              id(last_epever_data_publish) = now;
              id(mqtt_client).publish(topic + "/battery_capacity_epever", to_string(new_val));
            }

  - platform: modbus_controller
    modbus_controller_id: epever
    name: "EPEVER Device Temperature"
    id: epever_device_temp
    register_type: read
    address: 12561
    value_type: S_WORD
    filters:
      - multiply: 0.01
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    force_update: false
    on_value:
      then:
        - lambda: |-
            float new_val = x;
            float last_val = id(last_epever_device_temp);
            float threshold = 0.5;
            uint32_t now = millis();
            uint32_t last_publish = id(last_epever_data_publish);
            bool publish = false;
            if (last_val == -999.0) {
              publish = true;
            } else if (fabs(new_val - last_val) >= threshold) {
              publish = true;
            } else if ((now - last_publish) >= 60000) {
              publish = true;
            }
            if (publish) {
              id(last_epever_device_temp) = new_val;
              id(last_epever_data_publish) = now;
              id(mqtt_client).publish(topic + "/device_temp_epever", to_string(new_val));
            }

  - platform: modbus_controller
    modbus_controller_id: epever
    name: "EPEVER Battery Voltage"
    id: epever_battery_voltage
    register_type: read
    address: 13082
    value_type: U_WORD
    filters:
      - multiply: 0.01
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    force_update: false
    on_value:
      then:
        - lambda: |-
            float new_val = x;
            float last_val = id(last_epever_battery_voltage);
            float threshold = 0.1;
            uint32_t now = millis();
            uint32_t last_publish = id(last_epever_data_publish);
            bool publish = false;
            if (last_val == -1.0) {
              publish = true;
            } else if (fabs(new_val - last_val) >= threshold) {
              publish = true;
            } else if ((now - last_publish) >= 60000) {
              publish = true;
            }
            if (publish) {
              id(last_epever_battery_voltage) = new_val;
              id(last_epever_data_publish) = now;
              id(mqtt_client).publish(topic + "/battery_voltage_epever", to_string(new_val));
            }

  - platform: modbus_controller
    modbus_controller_id: epever
    name: "EPEVER Battery Current"
    id: epever_battery_current
    register_type: read
    address: 13083
    value_type: U_WORD
    filters:
      - multiply: 0.01
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    force_update: false
    on_value:
      then:
        - lambda: |-
            float new_val = x;
            float last_val = id(last_epever_battery_current);
            float threshold = 0.1;
            uint32_t now = millis();
            uint32_t last_publish = id(last_epever_data_publish);
            bool publish = false;
            if (last_val == -1.0) {
              publish = true;
            } else if (fabs(new_val - last_val) >= threshold) {
              publish = true;
            } else if ((now - last_publish) >= 60000) {
              publish = true;
            }
            if (publish) {
              id(last_epever_battery_current) = new_val;
              id(last_epever_data_publish) = now;
              id(mqtt_client).publish(topic + "/battery_current_epever", to_string(new_val));
            }

  - platform: modbus_controller
    modbus_controller_id: epever
    name: "EPEVER Total Energy"
    id: epever_total_energy
    register_type: read
    address: 13074
    value_type: U_DWORD_R
    filters:
      - multiply: 0.01
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    force_update: false
    on_value:
      then:
        - lambda: |-
            float new_val = x;
            float last_val = id(last_epever_total_energy);
            float threshold = 0.1;
            uint32_t now = millis();
            uint32_t last_publish = id(last_epever_data_publish);
            bool publish = false;
            if (last_val == -1.0) {
              publish = true;
            } else if (fabs(new_val - last_val) >= threshold) {
              publish = true;
            } else if ((now - last_publish) >= 60000) {
              publish = true;
            }
            if (publish) {
              id(last_epever_total_energy) = new_val;
              id(last_epever_data_publish) = now;
              id(mqtt_client).publish(topic + "/total_energy_epever", to_string(new_val));
            }

text_sensor:
  # Device info
  - platform: template
    name: "Phase Info"
    id: phase_info
    lambda: return std::string("Phase 2b SmartShunt + EPEVER Active");
    update_interval: 600s

  # SmartShunt text sensors
  - platform: victron
    victron_id: smartshunt
    model_description:
      name: "SmartShunt Model"
      id: ss_model_description
    firmware_version:
      name: "SmartShunt Firmware"
      id: ss_firmware_version
    device_type:
      name: "SmartShunt Device Type"
      id: ss_device_type
    serial_number:
      name: "SmartShunt Serial"
      id: ss_serial_number
    dc_monitor_mode:
      name: "SmartShunt Monitor Mode"
      id: ss_dc_monitor_mode
    alarm_condition_active:
      name: "SmartShunt Alarm Condition"
      id: ss_alarm_condition
    alarm_reason:
      name: "SmartShunt Alarm Reason"
      id: ss_alarm_reason

binary_sensor:
  # SmartShunt binary sensors
  - platform: victron
    victron_id: smartshunt
    relay_state:
      name: "SmartShunt Relay State"
      id: ss_relay_state

# =============================================================================
# GLOBALS - Hysteresis tracking for VE.Direct SmartShunt
# =============================================================================

globals:
  # VE.Direct SmartShunt hysteresis tracking
  - id: last_ss_battery_voltage
    type: float
    initial_value: '-1.0'
  - id: last_ss_battery_current
    type: float
    initial_value: '-1.0'
  - id: last_ss_state_of_charge
    type: int
    initial_value: '-1'
  - id: last_ss_instantaneous_power
    type: float
    initial_value: '-1.0'
  - id: last_ss_battery_temperature
    type: float
    initial_value: '-999.0'
  - id: last_ss_consumed_amp_hours
    type: float
    initial_value: '-999.0'
  - id: last_ss_time_to_go
    type: int
    initial_value: '-1'
  - id: last_ss_depth_deepest_discharge
    type: float
    initial_value: '-1.0'
  - id: last_ss_depth_last_discharge
    type: float
    initial_value: '-1.0'
  - id: last_ss_depth_average_discharge
    type: float
    initial_value: '-1.0'
  - id: last_ss_number_charge_cycles
    type: int
    initial_value: '-1'
  - id: last_ss_number_full_discharges
    type: int
    initial_value: '-1'
  - id: last_ss_min_battery_voltage
    type: float
    initial_value: '-1.0'
  - id: last_ss_max_battery_voltage
    type: float
    initial_value: '-1.0'
  - id: last_ss_last_full_charge
    type: int
    initial_value: '-1'
  - id: last_ss_amount_discharged_energy
    type: float
    initial_value: '-1.0'
  - id: last_ss_amount_charged_energy
    type: float
    initial_value: '-1.0'
  - id: last_ss_data_publish
    type: uint32_t
    initial_value: '0'

  # EPEVER MPPT hysteresis tracking
  - id: last_epever_solar_voltage
    type: float
    initial_value: '-1.0'
  - id: last_epever_pv_current
    type: float
    initial_value: '-1.0'
  - id: last_epever_solar_power
    type: float
    initial_value: '-1.0'
  - id: last_epever_battery_capacity
    type: int
    initial_value: '-1'
  - id: last_epever_device_temp
    type: float
    initial_value: '-999.0'
  - id: last_epever_battery_voltage
    type: float
    initial_value: '-1.0'
  - id: last_epever_battery_current
    type: float
    initial_value: '-1.0'
  - id: last_epever_total_energy
    type: float
    initial_value: '-1.0'
  - id: last_epever_data_publish
    type: uint32_t
    initial_value: '0'

  # HA Discovery tracking
  - id: discovery_sent
    type: bool
    initial_value: 'false'
    restore_value: false

# =============================================================================
# PHASE 3: HA Discovery Script
# =============================================================================
